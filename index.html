<html lang="en" ng-app="APP">
  <head>
    <meta charset="UTF-8" />
    <title>Blender Render Request Service</title>
  </head>

  <body>
    <!-- upload area -->
    <h1>This site is being worked on, Dan please don't upload anything yet</h1>
    <div style="margin: 20px auto auto; width: 800px">
      <h2 style="margin-bottom: 0px">Blender Render Request Service</h2>
      <div style="margin-bottom: 1em; font-style: italic">
        An absolutely bare bones blender render service
      </div>
      <div>
        <h3>For Single Image Render</h3>
        <form method="post" action="upload" enctype="multipart/form-data">
          <input
            type="file"
            name="fileUploaded"
            accept=".blend,.blend1,.blend2"
          />
          <input type="submit" />
        </form>
      </div>
      <div>
        <h3>For Animation Render</h3>
        <form
          method="post"
          action="uploadAnimation"
          enctype="multipart/form-data"
        >
          <input
            type="file"
            name="fileUploaded"
            accept=".blend,.blend1,.blend2"
          />
          <input type="number" name="startFrame" placeholder="start frame" />
          <input type="number" name="endFrame" placeholder="end frame" />
          <input type="submit" />
        </form>
      </div>
      <div>
        <h3>For Converting MKV / MOV / etc... to GIF</h3>
        <form method="post" action="uploadToGif" enctype="multipart/form-data">
          <input type="file" name="fileUploaded" />
          <input type="submit" />
        </form>
      </div>
    </div>

    <!-- loading area -->
    <div id="loadbox" style="display: none">
      We are loading your request
      <script>
        const getQueryParams = (searchString) => {
          const updatedString = searchString.split("?")[1];
          return updatedString.split("&").reduce((queryObject, query) => {
            const [key, value] = query.split("=");
            return { ...queryObject, [key]: value };
          }, {});
        };
        if (window.location.search.includes("request")) {
          const loadbox = document.getElementById("loadbox");
          loadbox.style = "";

          // loop through checking request
          const { requestId, file, type } = getQueryParams(
            window.location.search
          );
          setInterval(() => {
            new Promise(() => {
              fetch(`${window.location.href.split("?")[0]}request/${requestId}`)
                .then((rawResponse) => rawResponse.text())
                .then((response) => {
                  const isPidRunning = response === "true";
                  if (!isPidRunning) {
                    // if request failed, the request id no longer exists from the file being finished
                    window.location.href = `/?${type}=${file}`;
                  }
                  if (isPidRunning) {
                    console.log("retrying");
                  }
                });
            });
          }, 5000);
        }
      </script>
    </div>

    <!-- animation area -->
    <div id="videobox" style="display: none">
      <form id="delete-form-video" method="post" action="delete?file=test.png">
        <button type="submit" id="delete" style="margin-bottom: 5px">
          Delete video from server
        </button>
        <input id="filename-input-video" name="filename" disabled="true" />
        <video id="renderVideo" controls></video>
      </form>
      <script>
        if (
          window.location.search.includes("animation") &&
          !window.location.search.includes("request")
        ) {
          const videobox = document.getElementById("videobox");
          videobox.style = "";

          const filename = window.location.search.split("animation=")[1];
          const imageNode = document.getElementById("renderVideo");
          imageNode.src = filename;

          const fileNameInputField = document.getElementById(
            "filename-input-video"
          );
          fileNameInputField.value = filename;

          const deleteForm = document.getElementById("delete-form-video");
          deleteForm.action = `delete?file=${filename}`;
        }
      </script>
    </div>

    <!-- image area -->
    <div id="imagebox" style="display: none">
      <form id="delete-form" method="post" action="delete?file=test.png">
        <button type="submit" id="delete" style="margin-bottom: 5px">
          Delete image from server
        </button>
        <input id="filename-input" name="filename" disabled="true" />
        <img id="render" />
      </form>
      <script>
        if (
          window.location.search.includes("image") &&
          !window.location.search.includes("request")
        ) {
          const imagebox = document.getElementById("imagebox");
          imagebox.style = "";

          const filename = window.location.search.split("image=")[1];
          const imageNode = document.getElementById("render");
          imageNode.src = filename;

          const fileNameInputField = document.getElementById("filename-input");
          fileNameInputField.value = filename;

          const deleteForm = document.getElementById("delete-form");
          deleteForm.action = `delete?file=${filename}`;
        }
      </script>
    </div>
  </body>
</html>
